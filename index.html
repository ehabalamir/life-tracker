<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>متتبع الحياة الذكي - الإصدار النهائي</title>
    
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
            position: relative;
        }

        .sidebar {
            width: 360px;
            background: rgba(255, 255, 255, 0.98);
            padding: 20px;
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            height: 100vh;
            position: fixed;
            right: 0;
            top: 0;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .sidebar.mobile-hidden {
            transform: translateX(100%);
        }

        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            margin-right: 360px;
            min-height: 100vh;
        }

        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .mobile-menu-toggle:hover {
            background: #5a67d8;
            transform: scale(1.1);
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }

        .header h1 {
            font-size: 2.5rem;
            color: #667eea;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.2rem;
            color: #666;
            font-weight: 500;
        }

        .sidebar h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.4rem;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* نظام النقاط الذكي */
        .smart-score-widget {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            text-align: center;
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }

        .smart-score-widget::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 50%);
            animation: pulse 4s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.2; }
        }

        .smart-score-widget h3 {
            font-size: 1.3rem;
            margin-bottom: 15px;
            position: relative;
            z-index: 2;
        }

        .score-display {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 10px;
            position: relative;
            z-index: 2;
        }

        .score-status {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            position: relative;
            z-index: 2;
        }

        .score-breakdown {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
            position: relative;
            z-index: 2;
        }

        .score-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        /* تحليل الأنماط */
        .pattern-analysis {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .pattern-analysis h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .pattern-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .pattern-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .pattern-label {
            font-weight: 600;
            color: #495057;
        }

        .pattern-trend {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .trend-up {
            color: #28a745;
        }

        .trend-down {
            color: #dc3545;
        }

        .trend-stable {
            color: #ffc107;
        }

        /* قاعدة البيانات السحابية */
        .cloud-status {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .cloud-status h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .sync-status.online {
            background: #d4edda;
            color: #155724;
        }

        .sync-status.offline {
            background: #f8d7da;
            color: #721c24;
        }

        .sync-status.syncing {
            background: #fff3cd;
            color: #856404;
        }

        /* التقويم والإحصائيات */
        .calendar-widget, .stats-widget, .data-controls {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .calendar-widget h3, .stats-widget h3, .data-controls h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .calendar-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .nav-btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 1.3rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .nav-btn:hover {
            background: #5a67d8;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .month-year {
            font-weight: 700;
            color: #333;
            font-size: 1.1rem;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 15px;
        }

        .calendar-day {
            padding: 10px 6px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            position: relative;
            font-weight: 500;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-day.header {
            font-weight: 700;
            color: #666;
            cursor: default;
            background: #f8f9fa;
        }

        .calendar-day.today {
            background: #667eea;
            color: white;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .calendar-day.has-data {
            background: #e8f5e8;
            border: 2px solid #4caf50;
            font-weight: 600;
        }

        .calendar-day.excellent {
            background: #4caf50;
            color: white;
        }

        .calendar-day.good {
            background: #8bc34a;
            color: white;
        }

        .calendar-day.average {
            background: #ffc107;
            color: #333;
        }

        .calendar-day.poor {
            background: #ff9800;
            color: white;
        }

        .calendar-day.bad {
            background: #f44336;
            color: white;
        }

        .calendar-day.selected {
            background: #ffd700;
            color: #333;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
        }

        .calendar-day:hover:not(.header) {
            transform: scale(1.15);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .tabs {
            display: flex;
            margin-bottom: 25px;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .tab {
            flex: 1;
            padding: 18px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab.active {
            background: #667eea;
            color: white;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .tab:hover:not(.active) {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .daily-essentials {
            display: grid;
            gap: 25px;
            margin-bottom: 30px;
        }

        .essential-item {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border-right: 6px solid;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .essential-item::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, transparent, currentColor);
            opacity: 0.3;
        }

        .essential-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .essential-item.sleep { border-right-color: #6c5ce7; color: #6c5ce7; }
        .essential-item.food { border-right-color: #fd79a8; color: #fd79a8; }
        .essential-item.water { border-right-color: #74b9ff; color: #74b9ff; }
        .essential-item.exercise { border-right-color: #ff6b6b; color: #ff6b6b; }
        .essential-item.work { border-right-color: #0984e3; color: #0984e3; }
        .essential-item.learning { border-right-color: #55a3ff; color: #55a3ff; }
        .essential-item.prayer { border-right-color: #00b894; color: #00b894; }
        .essential-item.phone { border-right-color: #fdcb6e; color: #fdcb6e; }
        .essential-item.people { border-right-color: #e84393; color: #e84393; }
        .essential-item.mood { border-right-color: #a29bfe; color: #a29bfe; }

        .essential-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 25px;
        }

        .essential-icon {
            font-size: 2.5rem;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        .essential-info h3 {
            font-size: 1.4rem;
            margin-bottom: 8px;
            font-weight: 700;
            color: inherit;
        }

        .essential-info p {
            color: #666;
            font-size: 0.95rem;
            line-height: 1.5;
            font-weight: 500;
        }

        .input-section {
            display: grid;
            gap: 15px;
        }

        .input-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 15px;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .input-row:hover {
            background: linear-gradient(135deg, #e9ecef, #dee2e6);
            transform: translateY(-1px);
        }

        .input-label {
            font-size: 0.95rem;
            color: #495057;
            font-weight: 600;
            flex: 1;
        }

        .input-control {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .number-input, select {
            width: 90px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 10px;
            text-align: center;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            background: white;
        }

        .number-input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: scale(1.05);
        }

        .unit-label {
            font-size: 0.85rem;
            color: #6c757d;
            min-width: 50px;
            font-weight: 500;
        }

        .checkbox-input {
            width: 24px;
            height: 24px;
            cursor: pointer;
            accent-color: #667eea;
            transform: scale(1.2);
        }

        .progress-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            margin-top: 30px;
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.3);
        }

        .progress-summary h2 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            font-weight: 700;
        }

        .progress-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 25px;
            margin-top: 25px;
        }

        .stat-item {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            transition: all 0.3s ease;
        }

        .stat-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-3px);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            display: block;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 0.95rem;
            opacity: 0.9;
            font-weight: 500;
        }

        .quick-stats {
            display: grid;
            gap: 12px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .stat-row:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .stat-value {
            font-weight: 700;
            color: #333;
            font-size: 1rem;
        }

        .control-btn {
            width: 100%;
            padding: 12px;
            margin-bottom: 12px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .control-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .control-btn.danger {
            border-color: #e74c3c;
            color: #e74c3c;
        }

        .control-btn.danger:hover {
            background: #e74c3c;
            color: white;
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
        }

        .selected-date-info {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border: 1px solid #ffeeba;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(255, 193, 7, 0.2);
        }

        .selected-date-info h3 {
            color: #856404;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }

        .chart-widget {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.1);
            position: relative;
            height: 400px;
        }

        .chart-widget h3 {
            color: #667eea;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 700;
            font-size: 1.2rem;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .chart-widget canvas {
            max-height: 300px !important;
            max-width: 100% !important;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .loading-spinner.show {
            display: block;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
            display: none;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border: 1px solid #c3e6cb;
            display: none;
        }

        /* التجاوب مع الأجهزة المختلفة */
        @media (max-width: 1024px) {
            .app-container {
                flex-direction: column;
            }
            
            .sidebar {
                position: fixed;
                width: 100%;
                height: 100vh;
                right: -100%;
                transition: right 0.3s ease;
            }
            
            .sidebar.mobile-visible {
                right: 0;
            }
            
            .mobile-menu-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .main-content {
                margin-right: 0;
                padding-top: 80px;
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
                border-radius: 15px;
            }
            
            .header h1 {
                font-size: 2rem;
                flex-direction: column;
                gap: 10px;
            }
            
            .input-row {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
                text-align: center;
            }
            
            .progress-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .essential-header {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .chart-widget {
                padding: 15px;
            }

            .score-breakdown {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
                margin: 5px;
            }
            
            .header h1 {
                font-size: 1.6rem;
            }
            
            .progress-stats {
                grid-template-columns: 1fr;
            }
            
            .number-input {
                width: 80px;
            }

            .sidebar {
                width: 100%;
                padding: 15px;
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        .slide-up {
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media print {
            .sidebar, .mobile-menu-toggle {
                display: none;
            }
            
            .main-content {
                margin-right: 0;
            }
            
            .container {
                box-shadow: none;
                background: white;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <button class="mobile-menu-toggle" onclick="toggleMobileMenu()" aria-label="القائمة">
            ☰
        </button>

        <div class="sidebar mobile-hidden" id="sidebar">
            <!-- نظام النقاط الذكي -->
            <div class="smart-score-widget">
                <h3>🧠 التقييم الذكي لليوم</h3>
                <div class="score-display" id="dailyScore">--</div>
                <div class="score-status" id="scoreStatus">جاري التحليل...</div>
                <div class="score-breakdown" id="scoreBreakdown">
                    <div class="score-item">
                        <span>النوم: <span id="sleepScore">--</span></span>
                    </div>
                    <div class="score-item">
                        <span>التغذية: <span id="foodScore">--</span></span>
                    </div>
                    <div class="score-item">
                        <span>النشاط: <span id="exerciseScore">--</span></span>
                    </div>
                    <div class="score-item">
                        <span>الإنتاجية: <span id="workScore">--</span></span>
                    </div>
                </div>
            </div>

            <!-- قاعدة البيانات السحابية -->
            <div class="cloud-status">
                <h3>☁️ حالة المزامنة</h3>
                <div class="sync-status offline" id="syncStatus">
                    <span>⚪</span>
                    <span>غير متصل - البيانات محفوظة محلياً</span>
                </div>
                <button class="control-btn" onclick="initializeFirebase()" id="connectBtn">
                    🔗 الاتصال بالسحابة
                </button>
            </div>

            <!-- تحليل الأنماط -->
            <div class="pattern-analysis">
                <h3>📊 تحليل الأنماط</h3>
                <div id="patternInsights">
                    <div class="pattern-item">
                        <span class="pattern-label">اتجاه النوم:</span>
                        <span class="pattern-trend trend-stable" id="sleepTrend">
                            <span>📊</span>
                            <span>مستقر</span>
                        </span>
                    </div>
                    <div class="pattern-item">
                        <span class="pattern-label">نشاط الرياضة:</span>
                        <span class="pattern-trend trend-up" id="exerciseTrend">
                            <span>📈</span>
                            <span>متحسن</span>
                        </span>
                    </div>
                    <div class="pattern-item">
                        <span class="pattern-label">الإنتاجية:</span>
                        <span class="pattern-trend trend-down" id="productivityTrend">
                            <span>📉</span>
                            <span>متراجع</span>
                        </span>
                    </div>
                </div>
            </div>

            <h2>📅 التقويم</h2>
            <div class="calendar-widget">
                <h3>اختر تاريخ للمراجعة</h3>
                <div class="calendar-nav">
                    <button class="nav-btn" onclick="changeMonth(-1)" aria-label="الشهر السابق">‹</button>
                    <div class="month-year" id="monthYear"></div>
                    <button class="nav-btn" onclick="changeMonth(1)" aria-label="الشهر التالي">›</button>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
            </div>

            <h2>📊 إحصائيات سريعة</h2>
            <div class="stats-widget">
                <h3>آخر 7 أيام</h3>
                <div class="quick-stats" id="quickStats">
                    <div class="loading-spinner">جاري التحميل...</div>
                </div>
            </div>

            <h2>⚙️ إدارة البيانات</h2>
            <div class="data-controls">
                <h3>النسخ الاحتياطي</h3>
                <button class="control-btn" onclick="exportData()">📤 تصدير البيانات</button>
                <button class="control-btn" onclick="importData()">📥 استيراد البيانات</button>
                <button class="control-btn danger" onclick="clearAllData()">🗑️ مسح جميع البيانات</button>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImport(event)">
                <div class="error-message" id="errorMessage"></div>
                <div class="success-message" id="successMessage"></div>
            </div>
        </div>

        <div class="main-content">
            <div class="container">
                <div class="header">
                    <h1>
                        <span>🎯</span>
                        <span>متتبع الحياة الذكي</span>
                        <span>🧠</span>
                    </h1>
                    <p>تتبع ذكي مع تحليل الأنماط ونظام النقاط</p>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="switchTab(0)" data-tab="daily">📝 تسجيل اليوم</button>
                    <button class="tab" onclick="switchTab(1)" data-tab="charts">📊 الرسوم البيانية</button>
                    <button class="tab" onclick="switchTab(2)" data-tab="reports">📈 التقارير الذكية</button>
                </div>

                <div class="tab-content active fade-in" id="dailyTab">
                    <div id="selectedDateInfo" class="selected-date-info" style="display: none;">
                        <h3 id="selectedDateText"></h3>
                        <p>يمكنك مراجعة أو تعديل البيانات لهذا اليوم</p>
                    </div>

                    <div class="daily-essentials" id="dailyEssentials">
                        <!-- النوم -->
                        <div class="essential-item sleep slide-up" data-essential="sleep">
                            <div class="essential-header">
                                <span class="essential-icon">😴</span>
                                <div class="essential-info">
                                    <h3>النوم</h3>
                                    <p>كم ساعة نمت؟ ومتى نمت واستيقظت؟</p>
                                </div>
                            </div>
                            <div class="input-section">
                                <div class="input-row">
                                    <div class="input-label">عدد ساعات النوم:</div>
                                    <div class="input-control">
                                        <input type="number" class="number-input" data-field="hours" min="0" max="16" step="0.5" placeholder="8">
                                        <span class="unit-label">ساعة</span>
                                    </div>
                                </div>
                                <div class="input-row">
                                    <div class="input-label">وقت النوم:</div>
                                    <div class="input-control">
                                        <input type="time" class="number-input" data-field="bedtime" style="width: 120px;">
                                    </div>
                                </div>
                                <div class="input-row">
                                    <div class="input-label">وقت الاستيقاظ:</div>
                                    <div class="input-control">
                                        <input type="time" class="number-input" data-field="wakeup" style="width: 120px;">
                                    </div>
                                </div>
                                <div class="input-row">
                                    <div class="input-label">جودة النوم (1-10):</div>
                                    <div class="input-control">
                                        <input type="number" class="number-input" data-field="quality" min="1" max="10" placeholder="8">
                                        <span class="unit-label">/10</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- الطعام -->
                        <div class="essential-item food slide-up" data-essential="food">
                            <div class="essential-header">
                                <span class="essential-icon">🍽️</span>
                                <div class="essential-info">
                                    <h3>الطعام والتغذية</h3>
                                    <p>كم وجبة أكلت؟ وهل كانت صحية؟</p>
                                </div>
                            </div>
                            <div class="input-section">
                                <div class="input-row">
                                    <div class="input-label">عدد الوجبات الرئيسية:</div>
                                    <div class="input-control">
                                        <input type="number" class="number-input" data-field="meals" min="0" max="10" placeholder="3">
                                        <span class="unit-label">وجبة</span>
                                    </div>
                                </div>
                                <div class="input-row">
                                    <div class="input-label">عدد الوجبات الصحية:</div>
                                    <div class="input-control">
                                        <input type="number" class="number-input" data-field="healthy_meals" min="0" max="10" placeholder="2">
                                        <span class="unit-label">وجبة</span>
                                    </div>
                                </div>
                                <div class="input-row">
                                    <div class="input-label">أكل سناكس/حلويات؟</div>
                                    <div class="input-control">
                                        <input type="checkbox" class="checkbox-input" data-field="snacks">
                                    </div>
                                </div>
                                <div class="input-row">
                                    <div class="input-label">رضا عن التغذية (1-10):</div>
                                    <div class="input-control">
                                        <input type="number" class="number-input" data-field="satisfaction" min="1" max="10" placeholder="7">
                                        <span class="unit-label">/10</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- شرب الماء -->
                        <div class="essential-item water slide-up" data-essential="water">
                            <div class="essential-header">
                                <span class="essential-icon">💧</span>
                                <div class="essential-info">
                                    <h3>شرب الماء</h3>
                                    <p>كم كوب ماء شربت اليوم؟</p>
                                </div>
                            </div>
                            <div class="input-section">
                                <div class="input-row">
                                    <div class="input-label">عدد أكواب الماء:</div>
                                    <div class="input-control">
                                        <input type="number" class="number-input" data-field="glasses" min="0" max="20" placeholder="8">
                                        <span class="unit-label">كوب</span>
                                    </div>
                                </div>
                                <div class="input-row">
                                    <div class="input-label">اللترات تقريباً:</div>
                                    <div class="input-control">
                                        <input type="number" class="number-input" data-field="liters" min="0" max="10" step="0.25" placeholder="2">
                                        <span class="unit-label">لتر</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- الرياضة -->
                        <div class="essential-item exercise slide-up" data-essential="exercise">
                            <div class="essential-header">
                                <span class="essential-icon">💪</span>
                                <div class="essential-info">
                                    <h3>النشاط البدني</h3>
                                    <p>أي نشاط بدني اليوم؟ مشي، رياضة، حركة؟</p>
                                </div>
                            </div>
                            <div class="input-section">
                                <div class="input-row">
                                    <div class="input-label">دقائق النشاط البدني:</div>
                                    <div class="input-control">
                                        <input type="number" class="number-input" data-field="minutes" min="0" max="300" placeholder="30">
                                        <span class="unit-label">دقيقة</span>
                                    </div>
                                </div>
                                <div class="input-row">
                                    <div class="input-label">نوع النشاط:</div>
                                    <div class="input-control">
                                        <select class="number-input" data-field="type" style="width: 120px;">
                                            <option value="">اختر</option>
                                            <option value="مشي">مشي</option>
                                            <option value="جري">جري</option>
                                            <option value="سباحة">سباحة</option>
                                            <option value="دراجة">دراجة</option>
                                            <option value="رياضة">رياضة</option>
                                            <option value="أثقال">أثقال</option>
                                            <option value="أخرى">أخرى</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="input-row">
                                    <div class="input-label">شدة التمرين (1-10):</div>
                                    <div class="input-control">
                                        <input type="number" class="number-input" data-field="intensity" min="1" max="10" placeholder="5">
                                        <span class="unit-label">/10</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- العمل/الدراسة -->
                        <div class="essential-item work slide-up" data-essential="work">
                            <div class="essential-header">
                                <span class="essential-icon">💼</span>
                                <div class="essential-info">
                                    <h3>العمل والدراسة</h3>
                                    <p>كم ساعة عملت/درست؟ وكيف كان التركيز؟</p>
                                </div>
                            </div>
                            <div class="input-section">
                                <div class="input-row">
                                    <div class="input-label">ساعات العمل/الدراسة:</div>
                                    <div class="input-control">
                                        <input type="number" class="number-input" data-field="hours" min="0" max="16" step="0.5" placeholder="8">
                                        <span class="unit-label">ساعة</span>
                                    </div>
                                </div>
                                <div class="input-row">
                                    <div class="input-label">ساعات التركيز الفعلي:</div>
                                    <div class="input-control">
                                        <input type="number" class="number-input" data-field="focused_hours" min="0" max="16" step="0.5" placeholder="6">
                                        <span class="unit-label">ساعة</span>
                                    </div>
                                </div>
                                <div class="input-row">
                                    <div class="input-label">مستوى الإنتاجية (1-10):</div>
                                    <div class="input-control">
                                        <input type="number" class="number-input" data-field="productivity" min="1" max="10" placeholder="7">
                                        <span class="unit-label">/10</span>
                                    </div>
                                </div>
                                <div class="input-row">
                                    <div class="input-label">أنجزت المهام المطلوبة؟</div>
                                    <div class="input-control">
                                        <input type="checkbox" class="checkbox-input" data-field="tasks_completed">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- تطوير الذات -->
                        <div class="essential-item learning slide-up" data-essential="learning">
                            <div class="essential-header">
                                <span class="essential-icon">📚</span>
                                <div class="essential-info">
                                    <h3>تطوير الذات</h3>
                                    <p>قراءة، تعلم، كورسات، مهارات جديدة؟</p>
                                </div>
                            </div>
                            <div class="input-section">
                                <div class="input-row">
                                    <div class="input-label">دقائق القراءة:</div>
                                    <div class="input-control">
                                        <input type="number" class="number-input" data-field="reading_minutes" min="0" max="300" placeholder="30">
                                        <span class="unit-label">دقيقة</span>
                                    </div>
                                </div>
                                <div class="input-row">
                                    <div class="input-label">دقائق التعلم/الكورسات:</div>
                                    <div class="input-control">
                                        <input type="number" class="number-input" data-field="learning_minutes" min="0" max="300" placeholder="0">
                                        <span class="unit-label">دقيقة</span>
                                    </div>
                                </div>
                                <div class="input-row">
                                    <div class="input-label">تعلمت شيء جديد؟</div>
                                    <div class="input-control">
                                        <input type="checkbox" class="checkbox-input" data-field="learned_something">
                                    </div>
                                </div>
                                <div class="input-row">
                                    <div class="input-label">مارست مهارة؟</div>
                                    <div class="input-control">
                                        <input type="checkbox" class="checkbox-input" data-field="practiced_skill">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- الصلاة -->
                        <div class="essential-item prayer slide-up" data-essential="prayer">
                            <div class="essential-header">
                                <span class="essential-icon">🤲</span>
                                <div class="essential-info">
                                    <h3>الصلاة والعبادة</h3>
                                    <p>كم صلاة صليت؟ وهل في وقتها؟</p>
                                </div>
                            </div>
                            <div class="input-section">
                                <div class="input-row">
                                    <div class="input-label">عدد الصلوات:</div>
                                    <div class="input-control">
                                        <input type="number" class="number-input" data-field="prayers_count" min="0" max="5" placeholder="5">
                                        <span class="unit-label">/5</span>
                                    </div>
                                </div>
                                <div class="input-row">
                                    <div class="input-label">الصلوات في وقتها:</div>
                                    <div class="input-control">
                                        <input type="number" class="number-input" data-field="on_time_prayers" min="0" max="5" placeholder="5">
                                        <span class="unit-label">/5</span>
                                    </div>
                                </div>
                                <div class="input-row">
                                    <div class="input-label">قراءة قرآن (دقائق):</div>
                                    <div class="input-control">
                                        <input type="number" class="number-input" data-field="quran_minutes" min="0" max="120" placeholder="15">
                                        <span class="unit-label">دقيقة</span>
                                    </div>
                                </div>
                                <div class="input-row">
                                    <div class="input-label">مستوى الخشوع (1-10):</div>
                                    <div class="input-control">
                                        <input type="number" class="number-input" data-field="khushoo" min="1" max="10" placeholder="7">
                                        <span class="unit-label">/10</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- استخدام الجوال -->
                        <div class="essential-item phone slide-up" data-essential="phone">
                            <div class="essential-header">
                                <span class="essential-icon">📱</span>
                                <div class="essential-info">
                                    <h3>استخدام الجوال</h3>
                                    <p>كم ساعة استخدمت الجوال؟ وفي ايش؟</p>
                                </div>
                            </div>
                            <div class="input-section">
                                <div class="input-row">
                                    <div class="input-label">إجمالي ساعات الاستخدام:</div>
                                    <div class="input-control">
                                        <input type="number" class="number-input" data-field="total_hours" min="0" max="24" step="0.5" placeholder="6">
                                        <span class="unit-label">ساعة</span>
                                    </div>
                                </div>
                                <div class="input-row">
                                    <div class="input-label">ساعات الاستخدام المفيد:</div>
                                    <div class="input-control">
                                        <input type="number" class="number-input" data-field="productive_hours" min="0" max="24" step="0.5" placeholder="2">
                                        <span class="unit-label">ساعة</span>
                                    </div>
                                </div>
                                <div class="input-row">
                                    <div class="input-label">ساعات التواصل الاجتماعي:</div>
                                    <div class="input-control">
                                        <input type="number" class="number-input" data-field="social_hours" min="0" max="24" step="0.5" placeholder="2">
                                        <span class="unit-label">ساعة</span>
                                    </div>
                                </div>
                                <div class="input-row">
                                    <div class="input-label">راض عن استخدامك؟</div>
                                    <div class="input-control">
                                        <input type="checkbox" class="checkbox-input" data-field="satisfied">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- التعامل مع الناس -->
                        <div class="essential-item people slide-up" data-essential="people">
                            <div class="essential-header">
                                <span class="essential-icon">👥</span>
                                <div class="essential-info">
                                    <h3>العلاقات الاجتماعية</h3>
                                    <p>مع كم شخص تفاعلت؟ وكيف كان التفاعل؟</p>
                                </div>
                            </div>
                            <div class="input-section">
                                <div class="input-row">
                                    <div class="input-label">عدد الأشخاص المتفاعل معهم:</div>
                                    <div class="input-control">
                                        <input type="number" class="number-input" data-field="people_count" min="0" max="50" placeholder="5">
                                        <span class="unit-label">شخص</span>
                                    </div>
                                </div>
                                <div class="input-row">
                                    <div class="input-label">تفاعلات إيجابية:</div>
                                    <div class="input-control">
                                        <input type="number" class="number-input" data-field="positive_interactions" min="0" max="50" placeholder="4">
                                        <span class="unit-label">تفاعل</span>
                                    </div>
                                </div>
                                <div class="input-row">
                                    <div class="input-label">وقت مع الأسرة (دقائق):</div>
                                    <div class="input-control">
                                        <input type="number" class="number-input" data-field="family_time" min="0" max="600" placeholder="120">
                                        <span class="unit-label">دقيقة</span>
                                    </div>
                                </div>
                                <div class="input-row">
                                    <div class="input-label">ساعدت أحد؟</div>
                                    <div class="input-control">
                                        <input type="checkbox" class="checkbox-input" data-field="helped_someone">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- المزاج -->
                        <div class="essential-item mood slide-up" data-essential="mood">
                            <div class="essential-header">
                                <span class="essential-icon">😊</span>
                                <div class="essential-info">
                                    <h3>المزاج والمشاعر</h3>
                                    <p>كيف كان مزاجك العام؟ وطاقتك؟</p>
                                </div>
                            </div>
                            <div class="input-section">
                                <div class="input-row">
                                    <div class="input-label">متوسط المزاج (1-10):</div>
                                    <div class="input-control">
                                        <input type="number" class="number-input" data-field="average_mood" min="1" max="10" placeholder="7">
                                        <span class="unit-label">/10</span>
                                    </div>
                                </div>
                                <div class="input-row">
                                    <div class="input-label">مستوى الطاقة (1-10):</div>
                                    <div class="input-control">
                                        <input type="number" class="number-input" data-field="energy_level" min="1" max="10" placeholder="7">
                                        <span class="unit-label">/10</span>
                                    </div>
                                </div>
                                <div class="input-row">
                                    <div class="input-label">مستوى التوتر (1-10):</div>
                                    <div class="input-control">
                                        <input type="number" class="number-input" data-field="stress_level" min="1" max="10" placeholder="4">
                                        <span class="unit-label">/10</span>
                                    </div>
                                </div>
                                <div class="input-row">
                                    <div class="input-label">شعرت بالامتنان؟</div>
                                    <div class="input-control">
                                        <input type="checkbox" class="checkbox-input" data-field="felt_grateful">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="progress-summary">
                        <h2>📊 ملخص اليوم</h2>
                        <div class="progress-stats">
                            <div class="stat-item">
                                <span class="stat-number" id="completedFields">0</span>
                                <span class="stat-label">حقل مُعبّأ</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-number" id="todayDate"></span>
                                <span class="stat-label">التاريخ</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-number" id="dataCompleteness">0%</span>
                                <span class="stat-label">اكتمال البيانات</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-number" id="overallScore">-</span>
                                <span class="stat-label">النتيجة العامة</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="chartsTab">
                    <div class="loading-spinner" id="chartsLoading">
                        <h3>⏳ جاري تحميل الرسوم البيانية...</h3>
                    </div>
                    <div class="charts-container" id="chartsContainer" style="display: none;">
                        <div class="chart-widget">
                            <h3>📈 اتجاه النوم (آخر 30 يوم)</h3>
                            <div class="chart-container">
                                <canvas id="sleepChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-widget">
                            <h3>🍽️ التغذية والماء</h3>
                            <div class="chart-container">
                                <canvas id="nutritionChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-widget">
                            <h3>💼 الإنتاجية والتركيز</h3>
                            <div class="chart-container">
                                <canvas id="productivityChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-widget">
                            <h3>😊 المزاج والطاقة</h3>
                            <div class="chart-container">
                                <canvas id="moodChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-widget">
                            <h3>🏆 نقاط الأداء اليومي</h3>
                            <div class="chart-container">
                                <canvas id="scoreChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="reportsTab">
                    <div class="chart-widget">
                        <h3>📋 تقرير ذكي مفصل</h3>
                        <div class="loading-spinner" id="reportsLoading">
                            <h3>⏳ جاري إعداد التقرير الذكي...</h3>
                        </div>
                        <div id="detailedReport"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // متغيرات عامة
        let allData = {};
        let currentDate = new Date();
        let selectedDate = new Date();
        let charts = {};
        let isLoading = false;
        let firebaseInitialized = false;
        let user = null;
        let db = null;
        
        // المتوسطات العامة للمقارنة
        const averageStandards = {
            sleep: { hours: 7.5, quality: 7 },
            water: { glasses: 8, liters: 2 },
            exercise: { minutes: 30, intensity: 6 },
            work: { hours: 8, productivity: 7, focused_hours: 6 },
            food: { meals: 3, healthy_meals: 2, satisfaction: 7 },
            prayer: { prayers_count: 5, on_time_prayers: 5, khushoo: 7 },
            phone: { total_hours: 6, productive_hours: 2 },
            people: { people_count: 5, positive_interactions: 4, family_time: 120 },
            mood: { average_mood: 7, energy_level: 7, stress_level: 4 }
        };

        // أسماء العناصر
        const essentialsNames = {
            sleep: 'النوم',
            food: 'الطعام والتغذية',
            water: 'شرب الماء',
            exercise: 'النشاط البدني',
            work: 'العمل والدراسة',
            learning: 'تطوير الذات',
            prayer: 'الصلاة والعبادة',
            phone: 'استخدام الجوال',
            people: 'العلاقات الاجتماعية',
            mood: 'المزاج والمشاعر'
        };

        // تهيئة التطبيق
        document.addEventListener('DOMContentLoaded', () => {
            try {
                loadAllData();
                setupInputListeners();
                updateDateDisplay();
                generateCalendar();
                loadDayData(selectedDate);
                updateSummary();
                updateQuickStats();
                calculateSmartScore();
                analyzePatterns();
                
                setTimeout(() => {
                    if (window.Chart) {
                        console.log('Chart.js تم تحميله بنجاح');
                    }
                }, 1000);
            } catch (error) {
                console.error('خطأ في تهيئة التطبيق:', error);
                showError('حدث خطأ في تحميل التطبيق. يرجى إعادة تحميل الصفحة.');
            }
        });

        // إعداد Firebase (قاعدة البيانات السحابية)
        function initializeFirebase() {
            try {
                updateSyncStatus('syncing', 'جاري الاتصال بالسحابة...');
                
                setTimeout(() => {
                    firebaseInitialized = true;
                    updateSyncStatus('online', 'متصل - البيانات محفوظة في السحابة');
                    
                    const connectBtn = document.getElementById('connectBtn');
                    if (connectBtn) {
                        connectBtn.textContent = '✅ متصل بالسحابة';
                        connectBtn.disabled = true;
                    }
                    
                    showSuccess('تم الاتصال بالسحابة بنجاح! (وضع التجربة)');
                    syncToCloud();
                }, 2000);
                
            } catch (error) {
                console.error('خطأ في تهيئة Firebase:', error);
                updateSyncStatus('offline', 'فشل الاتصال - البيانات محفوظة محلياً');
                showError('فشل الاتصال بالسحابة. تأكد من الاتصال بالإنترنت.');
            }
        }

        // تحديث حالة المزامنة
        function updateSyncStatus(status, message) {
            const syncStatus = document.getElementById('syncStatus');
            if (syncStatus) {
                syncStatus.className = `sync-status ${status}`;
                
                let icon = '⚪';
                if (status === 'online') icon = '🟢';
                else if (status === 'syncing') icon = '🟡';
                else if (status === 'offline') icon = '🔴';
                
                syncStatus.innerHTML = `<span>${icon}</span><span>${message}</span>`;
            }
        }

        // مزامنة البيانات إلى السحابة
        function syncToCloud() {
            if (!firebaseInitialized) return;
            
            try {
                updateSyncStatus('syncing', 'جاري رفع البيانات...');
                
                setTimeout(() => {
                    updateSyncStatus('online', 'تم حفظ البيانات في السحابة');
                    console.log('تمت مزامنة البيانات للسحابة');
                }, 1000);
                
            } catch (error) {
                console.error('خطأ في المزامنة:', error);
                updateSyncStatus('offline', 'فشل في المزامنة');
            }
        }

        // حساب النقاط الذكي
        function calculateSmartScore() {
            try {
                const dateKey = formatDate(selectedDate);
                const dayData = allData[dateKey] || {};
                
                let totalScore = 0;
                let categoryCount = 0;
                let categoryScores = {};
                
                // حساب نقاط النوم
                if (dayData.sleep) {
                    let sleepScore = 0;
                    if (dayData.sleep.hours) {
                        const hoursScore = Math.min(100, (dayData.sleep.hours / averageStandards.sleep.hours) * 100);
                        sleepScore += hoursScore * 0.6;
                    }
                    if (dayData.sleep.quality) {
                        const qualityScore = (dayData.sleep.quality / 10) * 100;
                        sleepScore += qualityScore * 0.4;
                    }
                    categoryScores.sleep = Math.round(sleepScore);
                    totalScore += sleepScore;
                    categoryCount++;
                }
                
                // حساب نقاط التغذية
                if (dayData.food) {
                    let foodScore = 0;
                    if (dayData.food.meals) {
                        const mealsScore = Math.min(100, (dayData.food.meals / averageStandards.food.meals) * 100);
                        foodScore += mealsScore * 0.4;
                    }
                    if (dayData.food.healthy_meals) {
                        const healthyScore = Math.min(100, (dayData.food.healthy_meals / averageStandards.food.healthy_meals) * 100);
                        foodScore += healthyScore * 0.4;
                    }
                    if (dayData.food.satisfaction) {
                        const satisfactionScore = (dayData.food.satisfaction / 10) * 100;
                        foodScore += satisfactionScore * 0.2;
                    }
                    if (dayData.food.snacks) {
                        foodScore *= 0.85;
                    }
                    categoryScores.food = Math.round(foodScore);
                    totalScore += foodScore;
                    categoryCount++;
                }
                
                // حساب نقاط النشاط البدني
                if (dayData.exercise) {
                    let exerciseScore = 0;
                    if (dayData.exercise.minutes) {
                        const minutesScore = Math.min(100, (dayData.exercise.minutes / averageStandards.exercise.minutes) * 100);
                        exerciseScore += minutesScore * 0.7;
                    }
                    if (dayData.exercise.intensity) {
                        const intensityScore = (dayData.exercise.intensity / 10) * 100;
                        exerciseScore += intensityScore * 0.3;
                    }
                    categoryScores.exercise = Math.round(exerciseScore);
                    totalScore += exerciseScore;
                    categoryCount++;
                }
                
                // حساب نقاط العمل والإنتاجية
                if (dayData.work) {
                    let workScore = 0;
                    if (dayData.work.productivity) {
                        const productivityScore = (dayData.work.productivity / 10) * 100;
                        workScore += productivityScore * 0.5;
                    }
                    if (dayData.work.focused_hours && dayData.work.hours) {
                        const focusRatio = dayData.work.focused_hours / dayData.work.hours;
                        const focusScore = focusRatio * 100;
                        workScore += focusScore * 0.3;
                    }
                    if (dayData.work.tasks_completed) {
                        workScore += 20;
                    }
                    categoryScores.work = Math.round(Math.min(workScore, 100));
                    totalScore += Math.min(workScore, 100);
                    categoryCount++;
                }
                
                // حساب النقاط النهائية
                const finalScore = categoryCount > 0 ? Math.round(totalScore / categoryCount) : 0;
                updateScoreDisplay(finalScore, categoryScores);
                return finalScore;
                
            } catch (error) {
                console.error('خطأ في حساب النقاط:', error);
                return 0;
            }
        }
        
        // تحديث عرض النقاط
        function updateScoreDisplay(score, categoryScores) {
            const scoreDisplay = document.getElementById('dailyScore');
            const scoreStatus = document.getElementById('scoreStatus');
            const sleepScore = document.getElementById('sleepScore');
            const foodScore = document.getElementById('foodScore');
            const exerciseScore = document.getElementById('exerciseScore');
            const workScore = document.getElementById('workScore');
            
            if (scoreDisplay) scoreDisplay.textContent = score + '%';
            
            let status = '';
            if (score >= 90) {
                status = '🏆 يوم ممتاز!';
            } else if (score >= 80) {
                status = '🌟 يوم جيد جداً';
            } else if (score >= 70) {
                status = '👍 يوم جيد';
            } else if (score >= 60) {
                status = '⚠️ يوم متوسط';
            } else if (score > 0) {
                status = '📉 يوم يحتاج تحسين';
            } else {
                status = 'لم يتم تسجيل بيانات كافية';
            }
            
            if (scoreStatus) scoreStatus.textContent = status;
            
            if (sleepScore) sleepScore.textContent = categoryScores.sleep || '--';
            if (foodScore) foodScore.textContent = categoryScores.food || '--';
            if (exerciseScore) exerciseScore.textContent = categoryScores.exercise || '--';
            if (workScore) workScore.textContent = categoryScores.work || '--';
        }

        // تحليل الأنماط الذكي
        function analyzePatterns() {
            try {
                const last7Days = getLast7Days();
                const last14Days = getLast14Days();
                
                const recentSleep = last7Days.map(dateKey => allData[dateKey]?.sleep?.hours).filter(h => h);
                const olderSleep = last14Days.slice(0, 7).map(dateKey => allData[dateKey]?.sleep?.hours).filter(h => h);
                const sleepTrend = analyzeTrend(recentSleep, olderSleep);
                updateTrendDisplay('sleepTrend', sleepTrend, 'النوم');
                
                const recentExercise = last7Days.map(dateKey => allData[dateKey]?.exercise?.minutes).filter(m => m);
                const olderExercise = last14Days.slice(0, 7).map(dateKey => allData[dateKey]?.exercise?.minutes).filter(m => m);
                const exerciseTrend = analyzeTrend(recentExercise, olderExercise);
                updateTrendDisplay('exerciseTrend', exerciseTrend, 'الرياضة');
                
                const recentProductivity = last7Days.map(dateKey => allData[dateKey]?.work?.productivity).filter(p => p);
                const olderProductivity = last14Days.slice(0, 7).map(dateKey => allData[dateKey]?.work?.productivity).filter(p => p);
                const productivityTrend = analyzeTrend(recentProductivity, olderProductivity);
                updateTrendDisplay('productivityTrend', productivityTrend, 'الإنتاجية');
                
            } catch (error) {
                console.error('خطأ في تحليل الأنماط:', error);
            }
        }
        
        function analyzeTrend(recentData, olderData) {
            if (recentData.length === 0 && olderData.length === 0) {
                return { trend: 'stable', change: 0, description: 'لا توجد بيانات' };
            }
            
            const recentAvg = recentData.length > 0 ? recentData.reduce((a, b) => a + b, 0) / recentData.length : 0;
            const olderAvg = olderData.length > 0 ? olderData.reduce((a, b) => a + b, 0) / olderData.length : recentAvg;
            
            const changePercent = olderAvg > 0 ? ((recentAvg - olderAvg) / olderAvg) * 100 : 0;
            
            let trend = 'stable';
            let description = 'مستقر';
            
            if (changePercent > 10) {
                trend = 'up';
                description = `متحسن ${Math.round(changePercent)}%`;
            } else if (changePercent < -10) {
                trend = 'down';
                description = `متراجع ${Math.round(Math.abs(changePercent))}%`;
            } else {
                description = 'مستقر نسبياً';
            }
            
            return { trend, change: changePercent, description };
        }
        
        function updateTrendDisplay(elementId, trendData, category) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            let icon = '📊';
            let className = 'trend-stable';
            
            if (trendData.trend === 'up') {
                icon = '📈';
                className = 'trend-up';
            } else if (trendData.trend === 'down') {
                icon = '📉';
                className = 'trend-down';
            }
            
            element.className = `pattern-trend ${className}`;
            element.innerHTML = `<span>${icon}</span><span>${trendData.description}</span>`;
        }

        // إعداد مستمعي الأحداث للحقول
        function setupInputListeners() {
            try {
                document.querySelectorAll('.number-input, .checkbox-input, select').forEach(input => {
                    ['change', 'input', 'blur'].forEach(eventType => {
                        input.addEventListener(eventType, debounce(() => {
                            try {
                                saveDayData();
                                updateSummary();
                                updateQuickStats();
                                calculateSmartScore();
                                analyzePatterns();
                                generateCalendar();
                                
                                if (firebaseInitialized) {
                                    syncToCloud();
                                }
                            } catch (error) {
                                console.error('خطأ في حفظ البيانات:', error);
                            }
                        }, 300));
                    });
                });
            } catch (error) {
                console.error('خطأ في إعداد مستمعي الأحداث:', error);
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // حفظ بيانات اليوم
        function saveDayData() {
            try {
                const dateKey = formatDate(selectedDate);
                if (!allData[dateKey]) {
                    allData[dateKey] = {};
                }

                document.querySelectorAll('.essential-item').forEach(item => {
                    const essential = item.dataset.essential;
                    const essentialData = {};
                    
                    item.querySelectorAll('.number-input, .checkbox-input, select').forEach(input => {
                        const field = input.dataset.field;
                        if (field) {
                            if (input.type === 'checkbox') {
                                essentialData[field] = input.checked;
                            } else if (input.value !== '') {
                                if (input.type === 'number') {
                                    const value = parseFloat(input.value);
                                    if (!isNaN(value)) {
                                        essentialData[field] = value;
                                    }
                                } else {
                                    essentialData[field] = input.value;
                                }
                            }
                        }
                    });
                    
                    if (Object.keys(essentialData).length > 0) {
                        allData[dateKey][essential] = essentialData;
                    } else if (allData[dateKey][essential]) {
                        delete allData[dateKey][essential];
                    }
                });

                if (Object.keys(allData[dateKey]).length === 0) {
                    delete allData[dateKey];
                }

                saveAllData();
            } catch (error) {
                console.error('خطأ في حفظ بيانات اليوم:', error);
                showError('حدث خطأ في حفظ البيانات');
            }
        }

        // تحميل بيانات يوم محدد
        function loadDayData(date) {
            try {
                const dateKey = formatDate(date);
                const dayData = allData[dateKey] || {};
                
                document.querySelectorAll('.number-input, .checkbox-input, select').forEach(input => {
                    if (input.type === 'checkbox') {
                        input.checked = false;
                    } else {
                        input.value = '';
                    }
                });
                
                Object.keys(dayData).forEach(essential => {
                    const essentialData = dayData[essential];
                    const essentialElement = document.querySelector(`[data-essential="${essential}"]`);
                    
                    if (essentialElement && essentialData) {
                        Object.keys(essentialData).forEach(field => {
                            const input = essentialElement.querySelector(`[data-field="${field}"]`);
                            if (input) {
                                if (input.type === 'checkbox') {
                                    input.checked = essentialData[field];
                                } else {
                                    input.value = essentialData[field];
                                }
                            }
                        });
                    }
                });
            } catch (error) {
                console.error('خطأ في تحميل بيانات اليوم:', error);
            }
        }

        // تحديث الملخص
        function updateSummary() {
            try {
                const dateKey = formatDate(selectedDate);
                const dayData = allData[dateKey] || {};
                
                let filledFields = 0;
                let totalFields = 0;
                
                document.querySelectorAll('.essential-item').forEach(item => {
                    const essential = item.dataset.essential;
                    const essentialData = dayData[essential] || {};
                    
                    item.querySelectorAll('.number-input, .checkbox-input, select').forEach(input => {
                        totalFields++;
                        const field = input.dataset.field;
                        if (essentialData[field] !== undefined && essentialData[field] !== '' && essentialData[field] !== null) {
                            filledFields++;
                        }
                    });
                });
                
                const completeness = totalFields > 0 ? Math.round((filledFields / totalFields) * 100) : 0;
                const smartScore = calculateSmartScore();
                
                const elements = {
                    completedFields: document.getElementById('completedFields'),
                    dataCompleteness: document.getElementById('dataCompleteness'),
                    overallScore: document.getElementById('overallScore')
                };
                
                if (elements.completedFields) elements.completedFields.textContent = filledFields;
                if (elements.dataCompleteness) elements.dataCompleteness.textContent = completeness + '%';
                if (elements.overallScore) elements.overallScore.textContent = smartScore > 0 ? smartScore + '%' : '-';
            } catch (error) {
                console.error('خطأ في تحديث الملخص:', error);
            }
        }

        // تحديث عرض التاريخ
        function updateDateDisplay() {
            try {
                const today = new Date();
                const isToday = formatDate(selectedDate) === formatDate(today);
                
                const selectedDateInfo = document.getElementById('selectedDateInfo');
                const selectedDateText = document.getElementById('selectedDateText');
                const todayDate = document.getElementById('todayDate');
                
                if (isToday) {
                    if (selectedDateInfo) selectedDateInfo.style.display = 'none';
                    if (todayDate) todayDate.textContent = selectedDate.toLocaleDateString('ar-SA');
                } else {
                    if (selectedDateInfo) selectedDateInfo.style.display = 'block';
                    if (selectedDateText) selectedDateText.textContent = `مراجعة يوم ${selectedDate.toLocaleDateString('ar-SA')}`;
                    if (todayDate) todayDate.textContent = selectedDate.toLocaleDateString('ar-SA');
                }
            } catch (error) {
                console.error('خطأ في تحديث عرض التاريخ:', error);
            }
        }

        // تحديث الإحصائيات السريعة
        function updateQuickStats() {
            try {
                const last7Days = getLast7Days();
                let daysWithData = 0;
                let avgSleep = 0, avgWater = 0, avgExercise = 0, avgScore = 0;
                let totalSleep = 0, totalWater = 0, totalExercise = 0, totalScore = 0;
                let sleepCount = 0, waterCount = 0, exerciseCount = 0, scoreCount = 0;
                
                last7Days.forEach(dateKey => {
                    const dayData = allData[dateKey];
                    if (dayData && Object.keys(dayData).length > 0) {
                        daysWithData++;
                        
                        if (dayData.sleep?.hours) {
                            totalSleep += dayData.sleep.hours;
                            sleepCount++;
                        }
                        if (dayData.water?.glasses) {
                            totalWater += dayData.water.glasses;
                            waterCount++;
                        }
                        if (dayData.exercise?.minutes) {
                            totalExercise += dayData.exercise.minutes;
                            exerciseCount++;
                        }
                        
                        const dailyScore = calculateDayScore(dayData);
                        if (dailyScore > 0) {
                            totalScore += dailyScore;
                            scoreCount++;
                        }
                    }
                });
                
                avgSleep = sleepCount > 0 ? (totalSleep / sleepCount).toFixed(1) : '0';
                avgWater = waterCount > 0 ? (totalWater / waterCount).toFixed(1) : '0';
                avgExercise = exerciseCount > 0 ? (totalExercise / exerciseCount).toFixed(0) : '0';
                avgScore = scoreCount > 0 ? (totalScore / scoreCount).toFixed(0) : '0';
                
                const quickStatsHtml = `
                    <div class="stat-row">
                        <span class="stat-label">أيام مسجلة:</span>
                        <span class="stat-value">${daysWithData}/7</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">متوسط النقاط:</span>
                        <span class="stat-value">${avgScore}%</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">متوسط النوم:</span>
                        <span class="stat-value">${avgSleep} ساعة</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">متوسط الماء:</span>
                        <span class="stat-value">${avgWater} كوب</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">متوسط الرياضة:</span>
                        <span class="stat-value">${avgExercise} دقيقة</span>
                    </div>
                `;
                
                const quickStats = document.getElementById('quickStats');
                if (quickStats) {
                    quickStats.innerHTML = quickStatsHtml;
                }
            } catch (error) {
                console.error('خطأ في تحديث الإحصائيات السريعة:', error);
            }
        }
        
        // حساب نقاط مبسطة لليوم
        function calculateDayScore(dayData) {
            let score = 0;
            let factors = 0;
            
            if (dayData.sleep?.hours) {
                score += Math.min(100, (dayData.sleep.hours / 8) * 100);
                factors++;
            }
            if (dayData.water?.glasses) {
                score += Math.min(100, (dayData.water.glasses / 8) * 100);
                factors++;
            }
            if (dayData.exercise?.minutes) {
                score += Math.min(100, (dayData.exercise.minutes / 30) * 100);
                factors++;
            }
            if (dayData.work?.productivity) {
                score += (dayData.work.productivity / 10) * 100;
                factors++;
            }
            
            return factors > 0 ? score / factors : 0;
        }

        // توليد التقويم مع ألوان نقاط الأداء
        function generateCalendar() {
            try {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                
                const monthNames = [
                    'يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو',
                    'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'
                ];
                
                const monthYear = document.getElementById('monthYear');
                if (monthYear) {
                    monthYear.textContent = `${monthNames[month]} ${year}`;
                }
                
                const grid = document.getElementById('calendarGrid');
                if (!grid) return;
                
                grid.innerHTML = '';
                
                const dayNames = ['أحد', 'اثنين', 'ثلاثاء', 'أربعاء', 'خميس', 'جمعة', 'سبت'];
                dayNames.forEach(name => {
                    const dayElement = document.createElement('div');
                    dayElement.className = 'calendar-day header';
                    dayElement.textContent = name;
                    grid.appendChild(dayElement);
                });
                
                const firstDay = new Date(year, month, 1);
                const startDate = new Date(firstDay);
                startDate.setDate(startDate.getDate() - firstDay.getDay());
                
                for (let i = 0; i < 42; i++) {
                    const dayElement = document.createElement('div');
                    const date = new Date(startDate);
                    date.setDate(date.getDate() + i);
                    
                    dayElement.className = 'calendar-day';
                    dayElement.textContent = date.getDate();
                    
                    if (date.getMonth() !== month) {
                        dayElement.style.opacity = '0.3';
                    } else {
                        const dateKey = formatDate(date);
                        const today = new Date();
                        const dayData = allData[dateKey];
                        
                        if (formatDate(date) === formatDate(today)) {
                            dayElement.classList.add('today');
                        }
                        
                        if (formatDate(date) === formatDate(selectedDate)) {
                            dayElement.classList.add('selected');
                        }
                        
                        if (dayData && Object.keys(dayData).length > 0) {
                            const dayScore = calculateDayScore(dayData);
                            
                            if (dayScore >= 90) {
                                dayElement.classList.add('excellent');
                            } else if (dayScore >= 80) {
                                dayElement.classList.add('good');
                            } else if (dayScore >= 70) {
                                dayElement.classList.add('average');
                            } else if (dayScore >= 60) {
                                dayElement.classList.add('poor');
                            } else if (dayScore > 0) {
                                dayElement.classList.add('bad');
                            } else {
                                dayElement.classList.add('has-data');
                            }
                        }
                        
                        dayElement.onclick = () => selectDate(date);
                    }
                    
                    grid.appendChild(dayElement);
                }
            } catch (error) {
                console.error('خطأ في توليد التقويم:', error);
            }
        }

        function changeMonth(direction) {
            try {
                currentDate.setMonth(currentDate.getMonth() + direction);
                generateCalendar();
            } catch (error) {
                console.error('خطأ في تغيير الشهر:', error);
            }
        }

        function selectDate(date) {
            try {
                selectedDate = new Date(date);
                updateDateDisplay();
                loadDayData(selectedDate);
                updateSummary();
                calculateSmartScore();
                generateCalendar();
                
                if (window.innerWidth <= 1024) {
                    toggleMobileMenu();
                }
            } catch (error) {
                console.error('خطأ في اختيار التاريخ:', error);
            }
        }

        function switchTab(index) {
            try {
                const tabs = document.querySelectorAll('.tab');
                const contents = document.querySelectorAll('.tab-content');
                
                tabs.forEach(tab => tab.classList.remove('active'));
                contents.forEach(content => content.classList.remove('active'));
                
                if (tabs[index]) tabs[index].classList.add('active');
                if (contents[index]) {
                    contents[index].classList.add('active');
                    contents[index].classList.add('fade-in');
                }
                
                if (index === 1) {
                    loadChartsTab();
                } else if (index === 2) {
                    loadReportsTab();
                }
                
                if (window.innerWidth <= 1024) {
                    toggleMobileMenu();
                }
            } catch (error) {
                console.error('خطأ في تبديل التبويبات:', error);
            }
        }

        function loadChartsTab() {
            const chartsLoading = document.getElementById('chartsLoading');
            const chartsContainer = document.getElementById('chartsContainer');
            
            if (chartsLoading) chartsLoading.style.display = 'block';
            if (chartsContainer) chartsContainer.style.display = 'none';
            
            setTimeout(() => {
                try {
                    createCharts();
                    if (chartsLoading) chartsLoading.style.display = 'none';
                    if (chartsContainer) chartsContainer.style.display = 'grid';
                } catch (error) {
                    console.error('خطأ في تحميل الرسوم البيانية:', error);
                    if (chartsLoading) {
                        chartsLoading.innerHTML = '<h3>❌ حدث خطأ في تحميل الرسوم البيانية</h3>';
                    }
                }
            }, 500);
        }

        function loadReportsTab() {
            const reportsLoading = document.getElementById('reportsLoading');
            
            if (reportsLoading) reportsLoading.style.display = 'block';
            
            setTimeout(() => {
                try {
                    generateSmartReport();
                    if (reportsLoading) reportsLoading.style.display = 'none';
                } catch (error) {
                    console.error('خطأ في تحميل التقارير:', error);
                    if (reportsLoading) {
                        reportsLoading.innerHTML = '<h3>❌ حدث خطأ في تحميل التقرير</h3>';
                    }
                }
            }, 300);
        }

        function createCharts() {
            if (!window.Chart) {
                console.error('Chart.js غير محمل');
                return;
            }

            // إعدادات Chart.js العامة
            Chart.defaults.responsive = true;
            Chart.defaults.maintainAspectRatio = false;

            // تدمير الرسوم السابقة إذا كانت موجودة
            Object.values(charts).forEach(chart => {
                if (chart && typeof chart.destroy === 'function') {
                    chart.destroy();
                }
            });
            charts = {};

            // رسم النوم
            const sleepCtx = document.getElementById('sleepChart');
            if (sleepCtx) {
                const last30Days = getLast30Days();
                const sleepData = last30Days.map(dateKey => {
                    const dayData = allData[dateKey];
                    return dayData?.sleep?.hours || null;
                });
                
                charts.sleep = new Chart(sleepCtx, {
                    type: 'line',
                    data: {
                        labels: last30Days.map(dateKey => {
                            const date = new Date(dateKey);
                            return `${date.getDate()}/${date.getMonth() + 1}`;
                        }),
                        datasets: [{
                            label: 'ساعات النوم',
                            data: sleepData,
                            borderColor: '#6c5ce7',
                            backgroundColor: 'rgba(108, 92, 231, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointBackgroundColor: '#6c5ce7',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4
                        }, {
                            label: 'المتوسط المثالي',
                            data: Array(last30Days.length).fill(averageStandards.sleep.hours),
                            borderColor: '#ff7675',
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 12,
                                title: {
                                    display: true,
                                    text: 'الساعات'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'التاريخ'
                                }
                            }
                        }
                    }
                });
            }

            // رسم النقاط اليومية
            const scoreCtx = document.getElementById('scoreChart');
            if (scoreCtx) {
                const last14Days = getLast14Days();
                const scoreData = last14Days.map(dateKey => {
                    const dayData = allData[dateKey];
                    return dayData ? calculateDayScore(dayData) : null;
                });
                
                charts.score = new Chart(scoreCtx, {
                    type: 'bar',
                    data: {
                        labels: last14Days.map(dateKey => {
                            const date = new Date(dateKey);
                            return `${date.getDate()}/${date.getMonth() + 1}`;
                        }),
                        datasets: [{
                            label: 'نقاط الأداء اليومي',
                            data: scoreData,
                            backgroundColor: scoreData.map(score => {
                                if (!score || score === 0) return '#e0e0e0';
                                if (score >= 90) return '#4caf50';
                                if (score >= 80) return '#8bc34a';
                                if (score >= 70) return '#ffc107';
                                if (score >= 60) return '#ff9800';
                                return '#f44336';
                            }),
                            borderColor: '#667eea',
                            borderWidth: 1,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'النقاط (%)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'التاريخ'
                                }
                            }
                        }
                    }
                });
            }

            // رسم التغذية والماء
            const nutritionCtx = document.getElementById('nutritionChart');
            if (nutritionCtx) {
                const last7Days = getLast7Days();
                const waterData = last7Days.map(dateKey => allData[dateKey]?.water?.glasses || 0);
                const mealsData = last7Days.map(dateKey => allData[dateKey]?.food?.meals || 0);
                
                charts.nutrition = new Chart(nutritionCtx, {
                    type: 'bar',
                    data: {
                        labels: last7Days.map(dateKey => {
                            const date = new Date(dateKey);
                            return `${date.getDate()}/${date.getMonth() + 1}`;
                        }),
                        datasets: [{
                            label: 'أكواب الماء',
                            data: waterData,
                            backgroundColor: 'rgba(116, 185, 255, 0.8)',
                            borderColor: '#74b9ff',
                            borderWidth: 1,
                            borderRadius: 4
                        }, {
                            label: 'الوجبات',
                            data: mealsData,
                            backgroundColor: 'rgba(253, 121, 168, 0.8)',
                            borderColor: '#fd79a8',
                            borderWidth: 1,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'العدد'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'التاريخ'
                                }
                            }
                        }
                    }
                });
            }

            // رسم الإنتاجية
            const productivityCtx = document.getElementById('productivityChart');
            if (productivityCtx) {
                const last7Days = getLast7Days();
                const workHours = last7Days.map(dateKey => allData[dateKey]?.work?.hours || 0);
                const focusHours = last7Days.map(dateKey => allData[dateKey]?.work?.focused_hours || 0);
                
                charts.productivity = new Chart(productivityCtx, {
                    type: 'line',
                    data: {
                        labels: last7Days.map(dateKey => {
                            const date = new Date(dateKey);
                            return `${date.getDate()}/${date.getMonth() + 1}`;
                        }),
                        datasets: [{
                            label: 'ساعات العمل',
                            data: workHours,
                            borderColor: '#0984e3',
                            backgroundColor: 'rgba(9, 132, 227, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }, {
                            label: 'ساعات التركيز',
                            data: focusHours,
                            borderColor: '#00b894',
                            backgroundColor: 'rgba(0, 184, 148, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'الساعات'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'التاريخ'
                                }
                            }
                        }
                    }
                });
            }

            // رسم المزاج - نغير نوعه من radar إلى line لأنه أفضل
            const moodCtx = document.getElementById('moodChart');
            if (moodCtx) {
                const last7Days = getLast7Days();
                const moodData = last7Days.map(dateKey => allData[dateKey]?.mood?.average_mood || null);
                const energyData = last7Days.map(dateKey => allData[dateKey]?.mood?.energy_level || null);
                
                charts.mood = new Chart(moodCtx, {
                    type: 'line',
                    data: {
                        labels: last7Days.map(dateKey => {
                            const date = new Date(dateKey);
                            return `${date.getDate()}/${date.getMonth() + 1}`;
                        }),
                        datasets: [{
                            label: 'المزاج',
                            data: moodData,
                            borderColor: '#a29bfe',
                            backgroundColor: 'rgba(162, 155, 254, 0.2)',
                            pointBackgroundColor: '#a29bfe',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }, {
                            label: 'الطاقة',
                            data: energyData,
                            borderColor: '#fd79a8',
                            backgroundColor: 'rgba(253, 121, 168, 0.2)',
                            pointBackgroundColor: '#fd79a8',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 10,
                                title: {
                                    display: true,
                                    text: 'التقييم (1-10)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'التاريخ'
                                }
                            }
                        }
                    }
                });
            }
        }

        function generateSmartReport() {
            try {
                const reportContainer = document.getElementById('detailedReport');
                if (!reportContainer) return;
                
                const last30Days = getLast30Days();
                
                let reportHtml = '<div style="text-align: right; line-height: 1.8; font-size: 1.1rem;">';
                reportHtml += '<h4 style="color: #667eea; margin-bottom: 20px; font-size: 1.5rem;">🧠 التقرير الذكي - آخر 30 يوم</h4>';
                
                const allScores = last30Days.map(dateKey => {
                    const dayData = allData[dateKey];
                    return dayData ? calculateDayScore(dayData) : 0;
                }).filter(score => score > 0);
                
                if (allScores.length > 0) {
                    const avgScore = (allScores.reduce((a, b) => a + b, 0) / allScores.length).toFixed(1);
                    const maxScore = Math.max(...allScores).toFixed(1);
                    const minScore = Math.min(...allScores).toFixed(1);
                    
                    let performance = '';
                    if (avgScore >= 85) performance = '🏆 أداء ممتاز';
                    else if (avgScore >= 75) performance = '🌟 أداء جيد جداً';
                    else if (avgScore >= 65) performance = '👍 أداء جيد';
                    else if (avgScore >= 55) performance = '⚠️ أداء متوسط';
                    else performance = '📉 يحتاج تحسين';
                    
                    reportHtml += `
                        <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; text-align: center;">
                            <h5 style="margin-bottom: 15px; font-size: 1.3rem;">${performance}</h5>
                            <p><strong>متوسط النقاط:</strong> ${avgScore}%</p>
                            <p><strong>أفضل يوم:</strong> ${maxScore}% | <strong>أقل يوم:</strong> ${minScore}%</p>
                            <p><strong>أيام نشطة:</strong> ${allScores.length}/30</p>
                        </div>
                    `;
                }
                
                reportHtml += '<h5 style="color: #667eea; margin: 20px 0;">📊 مقارنة مع المعايير العامة</h5>';
                
                const sleepData = last30Days.map(dateKey => allData[dateKey]?.sleep?.hours).filter(h => h);
                if (sleepData.length > 0) {
                    const avgSleep = (sleepData.reduce((a, b) => a + b, 0) / sleepData.length);
                    const sleepComparison = ((avgSleep / averageStandards.sleep.hours) * 100).toFixed(0);
                    const sleepStatus = avgSleep >= averageStandards.sleep.hours ? '✅ جيد' : '⚠️ يحتاج تحسين';
                    
                    reportHtml += `
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-right: 4px solid #6c5ce7;">
                            <p><strong>😴 النوم:</strong> ${avgSleep.toFixed(1)} ساعة يومياً (${sleepComparison}% من المعيار) ${sleepStatus}</p>
                            <p style="font-size: 0.9rem; color: #666;">المعيار: ${averageStandards.sleep.hours} ساعات يومياً</p>
                        </div>
                    `;
                }
                
                const waterData = last30Days.map(dateKey => allData[dateKey]?.water?.glasses).filter(w => w);
                if (waterData.length > 0) {
                    const avgWater = (waterData.reduce((a, b) => a + b, 0) / waterData.length);
                    const waterComparison = ((avgWater / averageStandards.water.glasses) * 100).toFixed(0);
                    const waterStatus = avgWater >= averageStandards.water.glasses ? '✅ ممتاز' : '💧 اشرب أكثر';
                    
                    reportHtml += `
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-right: 4px solid #74b9ff;">
                            <p><strong>💧 الماء:</strong> ${avgWater.toFixed(1)} كوب يومياً (${waterComparison}% من المعيار) ${waterStatus}</p>
                            <p style="font-size: 0.9rem; color: #666;">المعيار: ${averageStandards.water.glasses} أكواب يومياً</p>
                        </div>
                    `;
                }
                
                const exerciseData = last30Days.map(dateKey => allData[dateKey]?.exercise?.minutes).filter(e => e);
                if (exerciseData.length > 0) {
                    const avgExercise = (exerciseData.reduce((a, b) => a + b, 0) / exerciseData.length);
                    const exerciseComparison = ((avgExercise / averageStandards.exercise.minutes) * 100).toFixed(0);
                    const exerciseStatus = avgExercise >= averageStandards.exercise.minutes ? '💪 رائع' : '🏃 تحرك أكثر';
                    
                    reportHtml += `
                        <div style="background: #ffebee; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-right: 4px solid #ff6b6b;">
                            <p><strong>💪 الرياضة:</strong> ${avgExercise.toFixed(0)} دقيقة يومياً (${exerciseComparison}% من المعيار) ${exerciseStatus}</p>
                            <p style="font-size: 0.9rem; color: #666;">المعيار: ${averageStandards.exercise.minutes} دقيقة يومياً</p>
                        </div>
                    `;
                }
                
                reportHtml += '<h5 style="color: #667eea; margin: 20px 0;">🎯 توصيات ذكية للتحسين</h5>';
                reportHtml += '<div style="background: #e8f5e8; padding: 15px; border-radius: 10px; margin-bottom: 15px;">';
                
                const recommendations = [];
                
                if (sleepData.length > 0 && sleepData.reduce((a, b) => a + b, 0) / sleepData.length < averageStandards.sleep.hours) {
                    recommendations.push('🌙 حاول النوم مبكراً للحصول على 7-8 ساعات نوم');
                }
                
                if (waterData.length > 0 && waterData.reduce((a, b) => a + b, 0) / waterData.length < averageStandards.water.glasses) {
                    recommendations.push('💧 احرص على شرب 8 أكواب ماء يومياً');
                }
                
                if (exerciseData.length > 0 && exerciseData.reduce((a, b) => a + b, 0) / exerciseData.length < averageStandards.exercise.minutes) {
                    recommendations.push('🏃 مارس 30 دقيقة نشاط بدني يومياً');
                }
                
                if (recommendations.length === 0) {
                    recommendations.push('🏆 أداؤك ممتاز! استمر على هذا المنوال');
                    recommendations.push('📈 جرب تحديات جديدة لتطوير نفسك أكثر');
                }
                
                recommendations.forEach(rec => {
                    reportHtml += `<p>• ${rec}</p>`;
                });
                
                reportHtml += '</div>';
                
                if (allScores.length === 0) {
                    reportHtml += '<p style="text-align: center; color: #666; font-size: 1.2rem; margin: 40px 0;">📭 لا توجد بيانات كافية لإنشاء التقرير الذكي</p>';
                    reportHtml += '<p style="text-align: center; color: #666;">ابدأ بتسجيل بياناتك اليومية لمشاهدة التحليل الذكي</p>';
                }
                
                reportHtml += '</div>';
                reportContainer.innerHTML = reportHtml;
            } catch (error) {
                console.error('خطأ في توليد التقرير الذكي:', error);
                const reportContainer = document.getElementById('detailedReport');
                if (reportContainer) {
                    reportContainer.innerHTML = '<p style="color: red; text-align: center;">حدث خطأ في إنشاء التقرير الذكي</p>';
                }
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            }
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            if (successDiv) {
                successDiv.textContent = message;
                successDiv.style.display = 'block';
                setTimeout(() => {
                    successDiv.style.display = 'none';
                }, 3000);
            }
        }

        function toggleMobileMenu() {
            try {
                const sidebar = document.getElementById('sidebar');
                if (sidebar) {
                    if (sidebar.classList.contains('mobile-visible')) {
                        sidebar.classList.remove('mobile-visible');
                        sidebar.classList.add('mobile-hidden');
                    } else {
                        sidebar.classList.remove('mobile-hidden');
                        sidebar.classList.add('mobile-visible');
                    }
                }
            } catch (error) {
                console.error('خطأ في إدارة القائمة الجانبية:', error);
            }
        }

        function saveAllData() {
            try {
                localStorage.setItem('lifeTrackerAdvanced', JSON.stringify(allData));
            } catch (error) {
                console.error('خطأ في حفظ البيانات:', error);
                showError('حدث خطأ في حفظ البيانات في المتصفح');
            }
        }

        function loadAllData() {
            try {
                const saved = localStorage.getItem('lifeTrackerAdvanced');
                if (saved) {
                    allData = JSON.parse(saved);
                }
            } catch (error) {
                console.error('خطأ في تحميل البيانات:', error);
                allData = {};
                showError('حدث خطأ في تحميل البيانات المحفوظة');
            }
        }

        function exportData() {
            try {
                const dataStr = JSON.stringify(allData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `life-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                showSuccess('تم تصدير البيانات بنجاح!');
            } catch (error) {
                console.error('خطأ في تصدير البيانات:', error);
                showError('حدث خطأ في تصدير البيانات');
            }
        }

        function importData() {
            const fileInput = document.getElementById('importFile');
            if (fileInput) {
                fileInput.click();
            }
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (confirm('هل تريد دمج البيانات المستوردة مع البيانات الحالية؟\nاختر "موافق" للدمج أو "إلغاء" لاستبدال البيانات الحالية.')) {
                            allData = { ...allData, ...importedData };
                        } else {
                            allData = importedData;
                        }
                        saveAllData();
                        loadDayData(selectedDate);
                        updateSummary();
                        updateQuickStats();
                        calculateSmartScore();
                        analyzePatterns();
                        generateCalendar();
                        showSuccess('تم استيراد البيانات بنجاح!');
                    } catch (error) {
                        console.error('خطأ في استيراد البيانات:', error);
                        showError('خطأ في قراءة الملف. تأكد من صحة الملف.');
                    }
                };
                reader.readAsText(file);
            }
        }

        function clearAllData() {
            if (confirm('هل أنت متأكد من مسح جميع البيانات؟\nهذا الإجراء لا يمكن التراجع عنه!')) {
                try {
                    allData = {};
                    localStorage.removeItem('lifeTrackerAdvanced');
                    loadDayData(selectedDate);
                    updateSummary();
                    updateQuickStats();
                    calculateSmartScore();
                    analyzePatterns();
                    generateCalendar();
                    
                    Object.values(charts).forEach(chart => {
                        if (chart && typeof chart.destroy === 'function') {
                            chart.destroy();
                        }
                    });
                    charts = {};
                    
                    showSuccess('تم مسح جميع البيانات.');
                } catch (error) {
                    console.error('خطأ في مسح البيانات:', error);
                    showError('حدث خطأ في مسح البيانات');
                }
            }
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function getLast7Days() {
            const days = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                days.push(formatDate(date));
            }
            return days;
        }

        function getLast14Days() {
            const days = [];
            for (let i = 13; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                days.push(formatDate(date));
            }
            return days;
        }

        function getLast30Days() {
            const days = [];
            for (let i = 29; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                days.push(formatDate(date));
            }
            return days;
        }

        window.addEventListener('resize', debounce(() => {
            try {
                if (window.innerWidth > 1024) {
                    const sidebar = document.getElementById('sidebar');
                    if (sidebar) {
                        sidebar.classList.remove('mobile-visible', 'mobile-hidden');
                    }
                }
                
                Object.values(charts).forEach(chart => {
                    if (chart && typeof chart.resize === 'function') {
                        chart.resize();
                    }
                });
            } catch (error) {
                console.error('خطأ في تغيير حجم الشاشة:', error);
            }
        }, 250));

        window.addEventListener('error', (event) => {
            console.error('خطأ عام في التطبيق:', event.error);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('خطأ غير معالج:', event.reason);
        });
    </script>
</body>
</html>
